<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />

    <title>MindCoach</title>

    <!-- Favicon for desktop / browser tab -->
    <link
      rel="icon"
      type="image/png"
      sizes="1024x1024"
      href="mindcoach-icon-1024.png"
    />

    <style>
      :root {
        --bg1: #f4f5fb;
        --bg2: #e9f0f4;
        --bg3: #fdf7ec;

        --card: #ffffff;
        --brand: #1b7e8d;

        /* Softer, cream chat bubbles */
        --bubble-ai: #fdf2dd;
        --bubble-you: #e6f0ff;

        --text: #2c3a4a;
        --muted: #7b8a9c;
        --border-soft: rgba(15, 163, 177, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Helvetica, Arial, sans-serif;
        color: var(--text);
        background:
          radial-gradient(circle at 12% 15%, rgba(244, 249, 255, 0.9), transparent 55%),
          radial-gradient(circle at 80% 80%, rgba(236, 248, 245, 0.9), transparent 55%),
          linear-gradient(135deg, var(--bg1), var(--bg2));
        display: flex;
        justify-content: center;
        align-items: stretch;
        padding: 16px;
      }

      .wrap {
        width: 100%;
        max-width: 860px;
        display: flex;
        justify-content: center;
        align-items: stretch;
      }

      .card {
        background: var(--card);
        border-radius: 28px;
        box-shadow:
          0 22px 45px rgba(15, 63, 89, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.8);
        padding: 24px 24px 18px;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 4px;
      }

      .brand_logo {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: radial-gradient(circle at 30% 20%, #fdf7ec, #0f808f);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow:
          0 10px 24px rgba(0, 0, 0, 0.2),
          0 0 0 1px rgba(255, 255, 255, 0.45);
        overflow: hidden;
      }

      .brand_logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .brand_title {
        display: flex;
        flex-direction: column;
      }

      .brand_title h1 {
        margin: 0;
        font-size: 24px;
        letter-spacing: 0.02em;
        font-weight: 700;
        color: var(--brand);
      }

      .tagline {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
      }

      .welcome {
        font-size: 13px;
        color: var(--muted);
        margin-top: 4px;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: var(--muted);
        margin-top: 6px;
      }

      .controls label {
        font-weight: 500;
      }

      select {
        font: inherit;
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        padding: 6px 20px 6px 10px;
        outline: none;
        background: #f9fbff;
      }

      select:focus {
        border-color: var(--brand);
        box-shadow: 0 0 0 2px rgba(15, 163, 177, 0.18);
      }

      #log {
        flex: 1;
        margin-top: 12px;
        padding: 10px 4px 10px 0;
        overflow-y: auto;
        max-height: 520px;
      }

      .msg {
        max-width: 85%;
        border-radius: 18px;
        padding: 10px 14px;
        font-size: 14px;
        line-height: 1.4;
        margin-bottom: 10px;
        box-shadow: 0 10px 28px rgba(15, 24, 40, 0.08);
        position: relative;
      }

      .msg.ai {
        background: var(--bubble-ai);
        align-self: flex-start;
      }

      .msg.you {
        background: var(--bubble-you);
        align-self: flex-end;
      }

      .msg strong.role {
        font-weight: 600;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        font-size: 11px;
        display: block;
        margin-bottom: 4px;
        color: var(--muted);
      }

      .msg .time {
        display: block;
        margin-top: 6px;
        font-size: 11px;
        color: var(--muted);
        text-align: right;
        opacity: 0.85;
      }

      .row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(15, 63, 89, 0.06);
      }

      #msg {
        flex: 1;
        border-radius: 999px;
        padding: 11px 16px;
        border: 1px solid var(--border-soft);
        background: #fbfcff;
        font: inherit;
        outline: none;
      }

      #msg::placeholder {
        color: var(--muted);
      }

      #msg:focus {
        border-color: var(--brand);
        box-shadow: 0 0 0 2px rgba(15, 163, 177, 0.18);
        background: #ffffff;
      }

      #send {
        border-radius: 999px;
        padding: 11px 22px;
        border: none;
        font-weight: 600;
        background: var(--brand);
        color: #ffffff;
        cursor: pointer;
        box-shadow: 0 12px 24px rgba(15, 163, 177, 0.35);
        transition: transform 0.08s ease-out, box-shadow 0.08s ease-out,
          background 0.08s ease-out;
      }

      #send:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 30px rgba(15, 163, 177, 0.4);
      }

      #send:active {
        transform: translateY(0);
        box-shadow: 0 8px 18px rgba(15, 163, 177, 0.25);
      }

      #send:disabled {
        opacity: 0.65;
        cursor: default;
        box-shadow: none;
      }

      .quota {
        font-size: 11px;
        color: var(--muted);
        margin-top: 4px;
        text-align: right;
      }

      /* Upgrade modal */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 24, 40, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 40;
      }

      .modal {
        background: #ffffff;
        border-radius: 22px;
        padding: 20px 22px 18px;
        max-width: 420px;
        width: 92%;
        box-shadow: 0 26px 60px rgba(15, 24, 40, 0.45);
      }

      .modal h2 {
        margin: 0 0 8px;
        font-size: 19px;
      }

      .modal p {
        margin: 0 0 10px;
        font-size: 13px;
        color: var(--muted);
      }

      .modal ul {
        margin: 0 0 12px 18px;
        padding: 0;
        font-size: 13px;
        color: var(--text);
      }

      .modal ul li {
        margin-bottom: 4px;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 6px;
      }

      .btn-outline,
      .btn-primary {
        border-radius: 999px;
        padding: 7px 14px;
        font-size: 13px;
        border: 1px solid var(--border-soft);
        background: #ffffff;
        cursor: pointer;
      }

      .btn-primary {
        background: var(--brand);
        color: #ffffff;
        border-color: var(--brand);
      }

      .btn-outline {
        color: var(--muted);
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .card {
          padding: 18px 16px 14px;
          border-radius: 22px;
        }

        .brand_title h1 {
          font-size: 20px;
        }

        #log {
          max-height: 60vh;
        }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="card">
        <!-- Header -->
        <div class="brand">
          <div class="brand_logo">
            <img src="mindcoach-icon-1024.png" alt="MindCoach logo" />
          </div>
          <div class="brand_title">
            <h1>MindCoach</h1>
            <p class="tagline">
              You matter. Youâ€™re heard. Calm guidance in every language by
              LuxeMind.
            </p>
          </div>
        </div>

        <p class="welcome">
          Welcome. Iâ€™m here for you with calm, clarity, and care. Whenever
          youâ€™re ready, tell me whatâ€™s on your mind.
        </p>

        <!-- Language + quota -->
        <div class="controls">
          <label for="langSelect">Language:</label>
          <select id="langSelect">
            <option value="auto">Auto</option>
            <option value="es">EspaÃ±ol</option>
            <option value="en">English</option>
            <option value="fr">FranÃ§ais</option>
            <option value="pt">PortuguÃªs</option>
            <option value="other">Other / Mixed</option>
          </select>
        </div>

        <div id="log"></div>

        <div class="row">
          <input
            id="msg"
            type="text"
            placeholder="Share whatâ€™s on your mindâ€¦ (Enter to send, Shift+Enter for a new line)"
            autocomplete="off"
          />
          <button id="send">Send</button>
        </div>

        <div class="quota" id="quotaNotice"></div>
      </div>
    </div>

    <!-- Upgrade Modal (hidden by default) -->
    <div class="modal-backdrop" id="upgradeModal" hidden>
      <div class="modal">
        <h2>Free messages used for today</h2>
        <p>
          Youâ€™ve reached todayâ€™s free limit of messages with MindCoach.
          Upgrade to continue chatting without limits and unlock more support.
        </p>
        <ul>
          <li>Unlimited conversations, every day</li>
          <li>Deeper emotional guidance & exercises</li>
          <li>Bilingual support (English & Spanish)</li>
          <li>Priority responses & longer answers</li>
        </ul>
        <p style="font-size: 12px; color: var(--muted);">
          You can start with a short free trial before your paid subscription
          begins.
        </p>
        <div class="modal-actions">
          <button class="btn-outline" id="closeUpgrade">Not now</button>
          <button class="btn-primary" id="goUpgrade">
            Upgrade to MindCoach Plus
          </button>
        </div>
      </div>
    </div>

    <script>
      const FREE_DAILY_MESSAGES = 5;

      const log = document.getElementById("log");
      const input = document.getElementById("msg");
      const btn = document.getElementById("send");
      const langSelect = document.getElementById("langSelect");
      const quotaNotice = document.getElementById("quotaNotice");
      const upgradeModal = document.getElementById("upgradeModal");
      const closeUpgrade = document.getElementById("closeUpgrade");
      const goUpgrade = document.getElementById("goUpgrade");

      function scrollToBottom() {
        log.scrollTop = log.scrollHeight;
      }

      function formatTime(date = new Date()) {
        return date.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Turn line breaks into <br> so bullets/paragraphs look nice
      function renderTextWithBreaks(text) {
        if (!text) return "";
        const escaped = text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;/");
        return escaped.replace(/\n/g, "<br />");
      }

      function add(role, text) {
        const div = document.createElement("div");
        div.className = "msg " + (role === "You" ? "you" : "ai");

        const html =
          '<strong class="role">' +
          role.toUpperCase() +
          "</strong>" +
          '<div class="content">' +
          renderTextWithBreaks(text || "") +
          "</div>" +
          '<span class="time">' +
          formatTime() +
          "</span>";

        div.innerHTML = html;
        log.appendChild(div);
        scrollToBottom();
        return div;
      }

      function addTyping() {
        const div = document.createElement("div");
        div.className = "msg ai";
        div.innerHTML =
          '<strong class="role">MINDCOACH</strong><div class="content">Typingâ€¦</div>';
        log.appendChild(div);
        scrollToBottom();
        return div;
      }

      // --- Free quota helpers (client-side only for now) ---

      function todayKey() {
        return new Date().toISOString().slice(0, 10);
      }

      function getUsage() {
        try {
          const raw = localStorage.getItem("mc_quota");
          if (!raw) return { date: todayKey(), count: 0 };
          const parsed = JSON.parse(raw);
          if (parsed.date !== todayKey()) {
            return { date: todayKey(), count: 0 };
          }
          return parsed;
        } catch {
          return { date: todayKey(), count: 0 };
        }
      }

      function saveUsage(usage) {
        try {
          localStorage.setItem("mc_quota", JSON.stringify(usage));
        } catch {
          // ignore
        }
      }

      function isProUser() {
        try {
          return localStorage.getItem("mc_is_pro") === "true";
        } catch {
          return false;
        }
      }

      function canSendMessage() {
        if (isProUser()) return true;
        const usage = getUsage();
        return usage.count < FREE_DAILY_MESSAGES;
      }

      function recordMessageSent() {
        if (isProUser()) return;
        const usage = getUsage();
        usage.count += 1;
        saveUsage(usage);
        updateQuotaNotice();
      }

      function updateQuotaNotice() {
        if (isProUser()) {
          quotaNotice.textContent = "MindCoach Plus: unlimited daily messages.";
          return;
        }
        const usage = getUsage();
        const remaining = Math.max(
          FREE_DAILY_MESSAGES - usage.count,
          0
        );
        quotaNotice.textContent =
          remaining > 0
            ? `Free messages left today: ${remaining} of ${FREE_DAILY_MESSAGES}.`
            : "Youâ€™ve used todayâ€™s free messages. Upgrade to keep chatting.";
      }

      function showUpgradeModal() {
        upgradeModal.hidden = false;
      }

      function hideUpgradeModal() {
        upgradeModal.hidden = true;
      }

      closeUpgrade.addEventListener("click", hideUpgradeModal);

      goUpgrade.addEventListener("click", () => {
        // TODO: Replace with your real Stripe Checkout link
        window.open, ("https://buy.stripe.com/6oUeV56dcgwFcn5axv63K00")

        // Temporary: mark as Pro so you can keep testing
        try {
          localStorage.setItem("mc_is_pro", "true");
        } catch {}
        hideUpgradeModal();
        updateQuotaNotice();
      });

      // --- Chat send logic ---

      async function send() {
        const message = input.value.trim();
        if (!message) return;

        if (!canSendMessage()) {
          showUpgradeModal();
          return;
        }

        add("You", message);
        input.value = "";
        input.focus();

        btn.disabled = true;
        btn.textContent = "Thinkingâ€¦";

        const typingDiv = addTyping();

        try {
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message,
              langMode: langSelect.value,
            }),
          });

          const data = await res.json();
          typingDiv.remove();

          if (!res.ok || !data || !data.text) {
            add(
              "MindCoach",
              "Lo siento, hubo un problema al generar la respuesta. / Iâ€™m sorry, something went wrong. Please try again in a moment."
            );
          } else {
            add("MindCoach", data.text);
            recordMessageSent();
          }
        } catch (e) {
          typingDiv.remove();
          add(
            "MindCoach",
            "Network error, cariÃ±o. Please check your connection and try again."
          );
        } finally {
          btn.disabled = false;
          btn.textContent = "Send";
          scrollToBottom();
        }
      }

      btn.onclick = send;

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      });

      // Initial quota text
      updateQuotaNotice();

      // Optional: initial warm greeting (one time per page load)
      add(
        "MindCoach",
        "Hello ðŸŒ± Iâ€™m glad youâ€™re here. How are you feeling right now?"
      );
    </script>
  </body>
</html>
