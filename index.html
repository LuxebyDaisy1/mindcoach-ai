<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Latina MindCoach</title>
  <link rel="stylesheet" href="styles.css" />

  <style>
    body {
      background: #ffffff;
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    #header {
      padding: 12px 20px 6px;
      border-bottom: 1px solid #eee;
      background: #ffffff;
    }

    #header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }

    #header p {
      margin: 4px 0 0;
      font-size: 14px;
      color: #555;
    }

    #lang-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 20px 8px;
      border-bottom: 1px solid #f3f3f3;
      background: #ffffff;
    }

    #lang-bar span {
      font-size: 12px;
      color: #666;
    }

    #lang-buttons button {
      border: 1px solid #ccc;
      border-radius: 14px;
      padding: 4px 8px;
      font-size: 11px;
      background: #fafafa;
      cursor: pointer;
    }

    #lang-buttons button.active {
      background: #525f7f;
      color: #fff;
      border-color: #525f7f;
    }

    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .message {
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 8px;
      max-width: 85%;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .user {
      background: #d9e6ff;
      align-self: flex-end;
    }

    .bot {
      background: #f2f2f2;
      align-self: flex-start;
    }

    #mood-bar {
      padding: 10px 20px 0;
      border-bottom: 1px solid #f0f0f0;
      background: #ffffff;
    }

    #mood-bar p {
      margin: 0 0 6px;
      font-size: 13px;
      color: #555;
    }

    #mood-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    #mood-buttons button {
      border: 1px solid #ccc;
      border-radius: 16px;
      padding: 6px 10px;
      font-size: 12px;
      background: #fafafa;
      cursor: pointer;
    }

    #mood-buttons button:hover {
      background: #f0f0f0;
    }

    #input-container {
      display: flex;
      border-top: 1px solid #ccc;
      padding: 12px;
      background: #fff;
    }

    #user-input {
      flex: 1;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    #send-btn {
      margin-left: 10px;
      padding: 12px 18px;
      font-size: 16px;
      background: #525f7f;
      color: white;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    #pause-btn {
      margin-left: 10px;
      padding: 12px 18px;
      font-size: 14px;
      background: #f5a623;
      color: #fff;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #paywall-note {
      padding: 8px 20px 4px;
      font-size: 12px;
      color: #555;
      border-top: 1px solid #f3f3f3;
      background: #ffffff;
    }

    stripe-buy-button {
      margin: 4px auto 16px;
      display: block;
    }
  </style>
</head>

<body>
  <div id="header">
    <h1>Latina MindCoach</h1>
    <p>For Latinas who carry everything.</p>
  </div>

  <div id="lang-bar">
    <span>Language mode:</span>
    <div id="lang-buttons">
      <button data-mode="auto" class="active">Auto</button>
      <button data-mode="en">EN</button>
      <button data-mode="es">ES</button>
    </div>
  </div>

  <div id="mood-bar">
    <p>How are you feeling right now?</p>
    <div id="mood-buttons">
      <button onclick="selectMood('anxious')">Anxious</button>
      <button onclick="selectMood('overwhelmed')">Overwhelmed</button>
      <button onclick="selectMood('sad')">Sad</button>
      <button onclick="selectMood('angry')">Angry</button>
      <button onclick="selectMood('numb')">Numb</button>
      <button onclick="selectMood('unknown')">I donâ€™t know</button>
    </div>
  </div>

  <div id="chat-container"></div>

  <div id="input-container">
    <input id="user-input" type="text" placeholder="Tell me how you feel right nowâ€¦" />
    <button id="pause-btn" type="button">La Pausa</button>
    <button id="send-btn" type="button">Send</button>
  </div>

  <div id="paywall-note">
    Unlimited daily support is available with the button below ðŸ’›
  </div>

  <script>
    const chatContainer = document.getElementById("chat-container");
    const input = document.getElementById("user-input");
    const btn = document.getElementById("send-btn");
    const pauseBtn = document.getElementById("pause-btn");
    const langButtonsContainer = document.getElementById("lang-buttons");
    const langButtons = langButtonsContainer.querySelectorAll("button");

    let langMode = "auto";

    const MAX_FREE_MESSAGES = 3; // number of AI replies before lock
    let usedMessages = Number(localStorage.getItem("lmc_usedMessages") || "0");
    let locked = usedMessages >= MAX_FREE_MESSAGES;

    const paywallText = `
Mi amor, ya usaste tus mensajes gratuitos de hoy ðŸ’›

Para seguir recibiendo apoyo emocional ilimitado, usa el botÃ³n de abajo para desbloquear tu acceso.

Iâ€™ll still be here when youâ€™re ready.
`.trim();

    const laPausaText = `
Breathe with me for a moment.

Youâ€™ve carried too much for too long, mi amor.
You donâ€™t have to solve anything right now. Just pause.

Inhaleâ€¦
Exhaleâ€¦

Youâ€™re safe in this moment.
Nothing is required of you right now.
Let your nervous system soften.

You are not behind.
You are not failing.
You are not alone.

This pause is healing you.
`.trim();

    function addMessage(sender, text) {
      const div = document.createElement("div");
      div.className = "message " + sender;
      div.textContent = text;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function lockChat(showMessage = true) {
      locked = true;
      localStorage.setItem("lmc_usedMessages", String(MAX_FREE_MESSAGES));
      if (showMessage) {
        addMessage("bot", paywallText);
      }
      input.disabled = true;
      input.placeholder = "Unlock unlimited support with the button below ðŸ’›";
      btn.disabled = true;
      btn.textContent = "Locked";
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      if (locked) {
        addMessage(
          "bot",
          "Mi amor, para seguir hablando conmigo, necesitas desbloquear tu apoyo ilimitado con el botÃ³n de abajo ðŸ’›"
        );
        return;
      }

      addMessage("user", text);
      input.value = "";

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ message: text, langMode })
        });

        const data = await response.json();

        if (data.reply) {
          addMessage("bot", data.reply);

          // count successful AI replies
          usedMessages += 1;
          localStorage.setItem("lmc_usedMessages", String(usedMessages));

          if (usedMessages >= MAX_FREE_MESSAGES && !locked) {
            lockChat(true);
          }
        } else if (data.error) {
          addMessage("bot", "Lo siento mi amor, algo fallÃ³: " + data.error);
        } else {
          addMessage("bot", "Lo siento mi amor, no entendÃ­ la respuesta del servidor.");
        }
      } catch (err) {
        addMessage("bot", "Lo siento mi amor, algo fallÃ³ al conectar. Try again in a moment.");
      }
    }

    function triggerLaPausa() {
      addMessage("bot", laPausaText);
    }

    function selectMood(mood) {
      let text = "";
      switch (mood) {
        case "anxious":
          text = "Iâ€™m feeling anxious and my mind is racing.";
          break;
        case "overwhelmed":
          text = "Iâ€™m overwhelmed and carrying too much right now.";
          break;
        case "sad":
          text = "I feel sad and low energy today.";
          break;
        case "angry":
          text = "I feel angry and frustrated.";
          break;
        case "numb":
          text = "I feel numb, like I canâ€™t even feel my emotions clearly.";
          break;
        case "unknown":
          text = "I donâ€™t even know how I feel, everything is mixed.";
          break;
      }
      if (!text) return;
      input.value = text;
      sendMessage();
    }

    function setLangMode(mode) {
      langMode = mode;

      langButtons.forEach(btnEl => {
        if (btnEl.getAttribute("data-mode") === mode) {
          btnEl.classList.add("active");
        } else {
          btnEl.classList.remove("active");
        }
      });
    }

    langButtonsContainer.addEventListener("click", (e) => {
      if (e.target.tagName.toLowerCase() === "button") {
        const mode = e.target.getAttribute("data-mode");
        if (mode) setLangMode(mode);
      }
    });

    btn.onclick = sendMessage;
    pauseBtn.onclick = triggerLaPausa;

    input.addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });

    // Initial greeting
    addMessage(
      "bot",
      "Hola mi amor ðŸ’› Soy tu Latina MindCoach. How are you feeling right now â€” anxious, overwhelmed, sad, angry, numb, or you donâ€™t know?"
    );

    // If already locked from previous session, lock UI immediately (no extra paywall message)
    if (locked) {
      lockChat(false);
    }
  </script>

  <!-- STRIPE BUY BUTTON -->
  <script async src="https://js.stripe.com/v3/buy-button.js"></script>

  <stripe-buy-button
    buy-button-id="buy_btn_1STXD50YpWkVmsiLFRmgapRw"
    publishable-key="pk_live_51STDB8OYpWkVmsiLwKPILRZMTvLu8FA21IrgrfoACFtO5qLaA1ofHHTPSJ0SWW6To6Z3MDZJ8yPDreptWiX0ta4L00Xrlp4X">
  </stripe-buy-button>

</body>
</html>
